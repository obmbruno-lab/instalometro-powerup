<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Helvetica Neue', sans-serif;
      padding: 12px;
      margin: 0;
      background: #fff;
    }
    .instalometro-status {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .status-card {
      padding: 12px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      border: 2px solid;
    }
    .status-card.empty {
      background: #f4f5f7;
      border-color: #dfe1e6;
      color: #5e6c84;
    }
    .status-card.identified {
      background: #e3fcef;
      border-color: #61bd4f;
      color: #216e4e;
    }
    .status-card.measured {
      background: #f3e5f5;
      border-color: #c377e0;
      color: #5e4db2;
    }
    .status-card.in-progress {
      background: #fff4e6;
      border-color: #f2d600;
      color: #974f0c;
    }
    .status-card.complete {
      background: #e3fcef;
      border-color: #61bd4f;
      color: #216e4e;
    }
    .status-details {
      display: flex;
      justify-content: space-around;
      padding: 8px;
      background: #f4f5f7;
      border-radius: 3px;
      font-size: 12px;
    }
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .status-label {
      color: #5e6c84;
      font-weight: 500;
    }
    .status-value {
      color: #172b4d;
      font-weight: 600;
      font-size: 14px;
    }
    .status-icon {
      font-size: 20px;
    }
    .help-text {
      font-size: 11px;
      color: #5e6c84;
      text-align: center;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="instalometro-status">
    <div class="status-card empty" id="main-status">
      <span class="status-icon">üìã</span>
      <div>Preencha as informa√ß√µes para come√ßar</div>
    </div>
    <div class="status-details" id="status-details" style="display: none;">
      <div class="status-item">
        <span class="status-label">OS</span>
        <span class="status-value" id="os-value">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">m¬≤</span>
        <span class="status-value" id="m2-value">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Tempo</span>
        <span class="status-value" id="time-value">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">m¬≤/h</span>
        <span class="status-value" id="prod-value">-</span>
      </div>
    </div>
    <div class="help-text">Use os bot√µes na lateral direita (Power-Ups) para registrar dados</div>
  </div>

  <script>
    var t = TrelloPowerUp.iframe();

    function updateStatus() {
      t.get('card', 'shared', 'instalometroData', {})
        .then(function(data) {
          var mainStatus = document.getElementById('main-status');
          var statusDetails = document.getElementById('status-details');
          
          var hasId = data.os && data.item_os && data.cliente;
          var hasMeasures = data.m2Total > 0;
          var hasCheckin = !!data.checkinTime;
          var hasCheckout = !!data.checkoutTime;

          // Atualizar status principal
          if (hasCheckout) {
            mainStatus.className = 'status-card complete';
            mainStatus.innerHTML = '<span class="status-icon">‚úÖ</span><div>Instala√ß√£o Conclu√≠da!</div>';
            statusDetails.style.display = 'flex';
            
            document.getElementById('os-value').textContent = data.os || '-';
            document.getElementById('m2-value').textContent = data.m2Total ? data.m2Total.toFixed(2) : '-';
            document.getElementById('time-value').textContent = data.horasTrabalhadas ? data.horasTrabalhadas.toFixed(1) + 'h' : '-';
            document.getElementById('prod-value').textContent = data.produtividade ? data.produtividade.toFixed(2) : '-';
            
          } else if (hasCheckin) {
            mainStatus.className = 'status-card in-progress';
            var elapsed = Math.floor((new Date() - new Date(data.checkinTime)) / 1000 / 60);
            var hours = Math.floor(elapsed / 60);
            var mins = elapsed % 60;
            var timeStr = hours > 0 ? hours + 'h ' + mins + 'min' : mins + 'min';
            mainStatus.innerHTML = '<span class="status-icon">‚è±Ô∏è</span><div>Em andamento h√° ' + timeStr + '</div>';
            statusDetails.style.display = 'flex';
            
            document.getElementById('os-value').textContent = data.os || '-';
            document.getElementById('m2-value').textContent = data.m2Total ? data.m2Total.toFixed(2) : '-';
            document.getElementById('time-value').textContent = timeStr;
            document.getElementById('prod-value').textContent = '-';
            
          } else if (hasMeasures) {
            mainStatus.className = 'status-card measured';
            mainStatus.innerHTML = '<span class="status-icon">üìê</span><div>Medidas registradas: ' + data.m2Total.toFixed(2) + ' m¬≤</div>';
            statusDetails.style.display = 'flex';
            
            document.getElementById('os-value').textContent = data.os || '-';
            document.getElementById('m2-value').textContent = data.m2Total.toFixed(2);
            document.getElementById('time-value').textContent = '-';
            document.getElementById('prod-value').textContent = '-';
            
          } else if (hasId) {
            mainStatus.className = 'status-card identified';
            mainStatus.innerHTML = '<span class="status-icon">üìã</span><div>OS ' + data.os + ' identificada</div>';
            statusDetails.style.display = 'flex';
            
            document.getElementById('os-value').textContent = data.os;
            document.getElementById('m2-value').textContent = '-';
            document.getElementById('time-value').textContent = '-';
            document.getElementById('prod-value').textContent = '-';
            
          } else {
            mainStatus.className = 'status-card empty';
            mainStatus.innerHTML = '<span class="status-icon">üìã</span><div>Preencha as informa√ß√µes para come√ßar</div>';
            statusDetails.style.display = 'none';
          }
        });
    }

    // Atualizar status inicial
    updateStatus();

    // Atualizar status a cada 30 segundos
    setInterval(updateStatus, 30000);

    // Escutar mudan√ßas nos dados
    t.render(function() {
      updateStatus();
    });
  </script>
</body>
</html>

