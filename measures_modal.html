<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Medidas</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 15px;
      background: #f4f5f7;
    }
    h3 {
      color: #172b4d;
      margin-top: 0;
      font-size: 18px;
    }
    label { 
      display: block; 
      margin-top: 12px;
      font-weight: 500;
      color: #172b4d;
      font-size: 14px;
    }
    input { 
      width: 100%; 
      padding: 8px;
      margin-top: 4px;
      border: 2px solid #dfe1e6;
      border-radius: 3px;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #0079bf;
    }
    input.error {
      border-color: #eb5a46;
    }
    .error-message {
      color: #eb5a46;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    button { 
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      background: #0079bf;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    button:hover {
      background: #026aa7;
    }
    .info {
      background: #e4f0f6;
      padding: 10px;
      border-radius: 3px;
      font-size: 12px;
      color: #172b4d;
      margin-bottom: 15px;
    }
    .preview {
      background: #fff;
      padding: 12px;
      border-radius: 3px;
      margin-top: 15px;
      border: 2px solid #dfe1e6;
    }
    .preview-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 14px;
    }
    .preview-label {
      color: #5e6c84;
    }
    .preview-value {
      font-weight: 600;
      color: #172b4d;
    }
  </style>
</head>
<body>
  <h3>üìè Medidas da Instala√ß√£o</h3>
  <div class="info">
    Informe as dimens√µes da instala√ß√£o. Todos os valores devem ser maiores que zero.
  </div>
  
  <label>Altura (metros) *</label>
  <input id="altura" type="number" step="0.01" min="0.01" placeholder="Ex: 2.50" required>
  <div class="error-message" id="altura-error">Valor deve ser maior que zero</div>
  
  <label>Largura (metros) *</label>
  <input id="largura" type="number" step="0.01" min="0.01" placeholder="Ex: 3.00" required>
  <div class="error-message" id="largura-error">Valor deve ser maior que zero</div>
  
  <label>Quantidade *</label>
  <input id="quantidade" type="number" step="1" min="1" placeholder="Ex: 5" required>
  <div class="error-message" id="quantidade-error">Valor deve ser maior que zero</div>
  
  <div class="preview" id="preview" style="display: none;">
    <div class="preview-item">
      <span class="preview-label">m¬≤ Unit√°rio:</span>
      <span class="preview-value" id="m2unit">-</span>
    </div>
    <div class="preview-item">
      <span class="preview-label">m¬≤ Total:</span>
      <span class="preview-value" id="m2total">-</span>
    </div>
  </div>
  
  <button id="save">üíæ Salvar Medidas</button>
  
  <script>
    var t = TrelloPowerUp.iframe();
    
    // Preencher valores existentes
    t.get('card','shared','instalometroData',{}).then(function(data){
      if (data.altura) document.getElementById('altura').value = data.altura;
      if (data.largura) document.getElementById('largura').value = data.largura;
      if (data.quantidade) document.getElementById('quantidade').value = data.quantidade;
      updatePreview();
    });
    
    // Atualizar preview ao digitar
    document.querySelectorAll('input').forEach(function(input) {
      input.addEventListener('input', updatePreview);
    });
    
    function updatePreview() {
      var altura = parseFloat(document.getElementById('altura').value) || 0;
      var largura = parseFloat(document.getElementById('largura').value) || 0;
      var quantidade = parseInt(document.getElementById('quantidade').value) || 0;
      
      if (altura > 0 && largura > 0 && quantidade > 0) {
        var m2Unit = altura * largura;
        var m2Total = m2Unit * quantidade;
        
        document.getElementById('preview').style.display = 'block';
        document.getElementById('m2unit').textContent = m2Unit.toFixed(2) + ' m¬≤';
        document.getElementById('m2total').textContent = m2Total.toFixed(2) + ' m¬≤';
      } else {
        document.getElementById('preview').style.display = 'none';
      }
    }
    
    // Valida√ß√£o e salvamento
    document.getElementById('save').addEventListener('click', function(){
      var altura = parseFloat(document.getElementById('altura').value);
      var largura = parseFloat(document.getElementById('largura').value);
      var quantidade = parseInt(document.getElementById('quantidade').value);
      
      // Limpar erros anteriores
      document.querySelectorAll('.error-message').forEach(function(el) {
        el.style.display = 'none';
      });
      document.querySelectorAll('input').forEach(function(el) {
        el.classList.remove('error');
      });
      
      // Validar campos
      var hasError = false;
      
      if (!altura || altura <= 0) {
        document.getElementById('altura').classList.add('error');
        document.getElementById('altura-error').style.display = 'block';
        hasError = true;
      }
      
      if (!largura || largura <= 0) {
        document.getElementById('largura').classList.add('error');
        document.getElementById('largura-error').style.display = 'block';
        hasError = true;
      }
      
      if (!quantidade || quantidade <= 0) {
        document.getElementById('quantidade').classList.add('error');
        document.getElementById('quantidade-error').style.display = 'block';
        hasError = true;
      }
      
      if (hasError) {
        return;
      }
      
      // Calcular valores
      var m2Unit = altura * largura;
      var m2Total = m2Unit * quantidade;
      
      t.get('card', 'shared', 'instalometroData', {}).then(function(data) {
        data = data || {};
        data.altura = altura;
        data.largura = largura;
        data.quantidade = quantidade;
        data.m2Unit = m2Unit;
        data.m2Total = m2Total;
        data.lastUpdated = new Date().toISOString();
        
        // Recalcula produtividade se houver check-in/out
        if (data.checkinTime && data.checkoutTime) {
          var hours = (new Date(data.checkoutTime) - new Date(data.checkinTime)) / (1000*60*60);
          if (hours > 0) {
            data.produtividade = m2Total / hours;
          }
        }
        
        t.set('card','shared','instalometroData',data).then(function(){
          t.alert({
            message: '‚úÖ Medidas salvas! Total: ' + m2Total.toFixed(2) + ' m¬≤',
            duration: 3
          }).then(function() {
            t.closePopup();
          });
        });
      });
    });
  </script>
</body>
</html>

